import{E as o}from"./index.js";const e=require("os"),r=require("fs"),s=require("path"),{pipeline:t}=require("stream"),{execSync:n}=require("child_process");const c={windows:"package.nw.zip",macos:"app.nw.zip"}[{win32:"windows",darwin:"macos",linux:"linux"}[e.platform()]],a=s.dirname(process.cwd());async function i(e,s){const n=new AbortController;try{const c=await((e,r={},s=5e3)=>{const t=new AbortController,n=setTimeout((()=>{t.abort(),o.error("下载资源超时(((ﾟДﾟ;)))"),console.error("Download aborted due to timeout")}),s);return r.signal=t.signal,fetch(e,r).finally((()=>clearTimeout(n)))})(e,{method:"GET",signal:n.signal},1e4);if(!c.ok)throw new Error(`Failed to fetch: HTTP ${c.status}`);const a=r.createWriteStream(s),i=c.body,l=setTimeout((()=>{n.abort(),console.error("Download aborted due to timeout"),o.error("下载资源超时(((ﾟДﾟ;)))")}),1e4);if(await new Promise(((o,e)=>{t(i,a,(r=>{clearTimeout(l),r?e(r):o()}))})),0===r.statSync(s).size)throw o.error("下载文件为空，请检查网络连接(;´༎ຶД༎ຶ`)"),new Error("Downloaded file is empty");console.log(`File downloaded to ${s}`),o.success("下载资源成功(≧∀≦)ゞ")}catch(c){console.error("Error downloading source:",c)}}async function l(){const e=await fetch("https://api.github.com/repos/CrazySpottedDove/Lab-Assistance/releases/latest"),t=await e.json();const l=function(o){for(let e=0;e<t.assets.length;e++)if(t.assets[e].name===o)return console.log("get Source:"+t.assets[e].name),console.log("source Url:"+t.assets[e].browser_download_url),t.assets[e].browser_download_url;return null}(c);if(!l)throw o.error("未找到对应资源，请检查网络连接(;´༎ຶД༎ຶ`)"),new Error("No source found");const u=s.join(a,c);return console.log("current path"+a),console.log("source name"+c),await i(l,u),await async function(e){try{n(`unzip -o ${e} -d ${a}`),console.log("Extraction successful!"),o.success("解压缩并替换成功⁽⁽ ◟(∗ ˊωˋ ∗)◞ ⁾⁾"),o.success("请重启软件以使用新版本(*/ω＼*)")}catch(r){console.error("Error extracting zip file:",r),o.error("解压缩失败，请检查文件权限(;´༎ຶД༎ຶ`)")}}(u),await async function(e){try{r.chmodSync(e,511),r.unlinkSync(e),console.log("File deleted successfully!"),o.success("删除压缩包成功(*´∀`)~♥")}catch(s){console.error(`Failed to delete ${e}:`,s),o.error("删除压缩包失败，请检查文件权限(;´༎ຶД༎ຶ`)")}}(u),!0}export{l as updateVersion};
